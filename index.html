<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1e3c72">
    <title>üêì Rooster Runner Pro</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Poppins:wght@400;600;700;800&display=swap');
        
        :root {
            --primary-grad: linear-gradient(135deg, #4A90E2 0%, #357ABD 100%);
            --secondary-grad: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
            --glass-bg: rgba(255, 255, 255, 0.15);
            --glass-border: rgba(255, 255, 255, 0.25);
            --text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; -webkit-user-select: none; }

        html, body {
            width: 100%; height: 100%; position: fixed; overflow: hidden;
            font-family: 'Poppins', sans-serif; background: #000;
        }

        /* SFONDO E ATMOSFERA */
        #gameContainer {
            position: relative; width: 100%; height: 100%;
            background: linear-gradient(to bottom, #87CEEB 0%, #E0F6FF 50%, #228B22 100%);
            transition: background 1s ease; overflow: hidden;
        }

        /* TEMI */
        #gameContainer.theme-sunset { background: linear-gradient(to bottom, #FF6B6B, #FFD700 50%, #CD5C5C 100%); }
        #gameContainer.theme-night { background: linear-gradient(to bottom, #0f2027, #2c5364 50%, #0f2f1f 100%); }
        #gameContainer.theme-desert { background: linear-gradient(to bottom, #F4A460, #FFE4B5 50%, #8B7355 100%); }
        #gameContainer.theme-ocean { background: linear-gradient(to bottom, #4A90E2, #85C1E9 50%, #2874A6 100%); }
        #gameContainer.theme-candy { background: linear-gradient(to bottom, #FFB6C1, #FFE4E1 50%, #FF1493 100%); }

        /* HUD & UI ELEMENTS */
        #hud {
            position: absolute; top: 0; left: 0; width: 100%; padding: 2vh 3vw;
            display: flex; justify-content: space-between; z-index: 50;
            pointer-events: none; /* Lascia cliccare sotto */
        }

        .panel {
            background: rgba(255,255,255,0.9); padding: 1vh 2vw; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); border: 2px solid rgba(255,255,255,0.8);
            display: flex; flex-direction: column; align-items: center;
        }

        .panel-label { font-size: 1.2vh; color: #666; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
        .panel-value { font-family: 'Press Start 2P', cursive; font-size: 2.5vh; background: -webkit-linear-gradient(#333, #000); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-top: 0.5vh; }

        #livesPanel { flex-direction: row; gap: 5px; align-items: center; }
        .heart { font-size: 3vh; transition: 0.3s; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2)); }
        .heart.lost { opacity: 0.3; transform: scale(0.8) grayscale(1); }

        /* BUTTONS TOP RIGHT */
        #topButtons {
            position: absolute; top: 2vh; right: 3vw; display: flex; gap: 1.5vh; z-index: 60;
        }

        .icon-btn {
            width: 6vh; height: 6vh; border-radius: 12px;
            background: rgba(255,255,255,0.9);
            display: flex; justify-content: center; align-items: center;
            font-size: 3vh; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); border: 2px solid white;
            transition: transform 0.1s, background 0.2s;
            pointer-events: auto;
        }
        .icon-btn:active { transform: scale(0.9); }
        .icon-btn.disabled { opacity: 0.5; pointer-events: none; filter: grayscale(1); }

        /* GAME OBJECTS */
        #ground {
            position: absolute; bottom: 0; width: 100%; height: 12vh;
            background: linear-gradient(180deg, #5D4037 0%, #3E2723 100%);
            border-top: 6px solid #8D6E63; z-index: 20;
        }
        .grass-container { position: absolute; bottom: 11.5vh; width: 100%; z-index: 25; display: flex; }
        .grass { font-size: 4vh; animation: moveGrass 2s linear infinite; position: absolute; bottom: 0; }
        @keyframes moveGrass { from { transform: translateX(0); } to { transform: translateX(-10vw); } }

        #rooster {
            position: absolute; bottom: 12vh; left: 15vw; font-size: 9vh; z-index: 30;
            filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.4));
            transform-origin: center bottom; will-change: transform;
        }
        #rooster.running { animation: bounce 0.4s infinite alternate; }
        @keyframes bounce { from { transform: scaleX(-1) translateY(0); } to { transform: scaleX(-1) translateY(-1vh); } }
        
        .obstacle, .powerup, .enemy { position: absolute; will-change: transform; z-index: 28; filter: drop-shadow(2px 4px 4px rgba(0,0,0,0.3)); font-size: 7vh; }
        .enemy { bottom: 35vh; animation: fly 1s infinite alternate ease-in-out; }
        @keyframes fly { from { transform: translateY(0); } to { transform: translateY(-2vh); } }

        /* SCREENS (Start, Pause, GameOver) */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(8px);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 100; transition: opacity 0.3s;
        }
        .screen.hidden { opacity: 0; pointer-events: none; }

        h1 {
            font-family: 'Press Start 2P', cursive; color: #FFD700;
            font-size: 5vh; text-align: center; line-height: 1.5;
            text-shadow: 4px 4px 0 #000; margin-bottom: 1vh;
        }
        
        .subtitle { color: white; font-size: 2vh; margin-bottom: 4vh; opacity: 0.9; }

        .btn-group { display: flex; flex-direction: column; gap: 2vh; width: 80%; max-width: 400px; }
        
        .main-btn {
            background: var(--primary-grad); color: white; border: none;
            padding: 2.5vh; border-radius: 1.5vh; font-size: 2.2vh; font-weight: 800;
            font-family: 'Poppins', sans-serif; text-transform: uppercase; letter-spacing: 1px;
            box-shadow: 0 6px 0 #2c5282; cursor: pointer; transition: transform 0.1s, box-shadow 0.1s;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .main-btn:active { transform: translateY(6px); box-shadow: 0 0 0 transparent; }
        .main-btn.secondary { background: #555; box-shadow: 0 6px 0 #333; }
        .main-btn.settings-trigger { background: #6c5ce7; box-shadow: 0 6px 0 #4834d4; }

        /* SETTINGS MENU (OVERLAY) */
        #settingsOverlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10, 10, 10, 0.95); z-index: 300; /* Highest Priority */
            display: flex; flex-direction: column; padding: 4vh 5vw;
            overflow-y: auto; transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #settingsOverlay.active { transform: translateY(0); }

        .settings-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4vh; }
        .close-btn { background: rgba(255,255,255,0.2); width: 6vh; height: 6vh; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 3vh; color: white; cursor: pointer; }

        .setting-group { margin-bottom: 4vh; }
        .setting-title { color: #FFD700; font-size: 2.2vh; margin-bottom: 2vh; font-weight: 700; text-transform: uppercase; }
        .grid-options { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 1.5vh; }
        
        .opt-btn {
            background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.1);
            border-radius: 12px; padding: 1.5vh; color: white; cursor: pointer; text-align: center;
            transition: 0.2s;
        }
        .opt-btn.active { background: var(--primary-grad); border-color: white; transform: scale(1.05); }
        .opt-btn .emoji { display: block; font-size: 4vh; margin-bottom: 0.5vh; }

        /* COUNTDOWN */
        #countdown {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 15vh; font-family: 'Press Start 2P', cursive; color: #fff;
            text-shadow: 0 0 20px rgba(0,0,0,0.8); z-index: 150; pointer-events: none;
            display: none;
        }

        /* NOTIFICATIONS */
        .notif {
            position: absolute; left: 50%; top: 30%; transform: translate(-50%, -50%) scale(0);
            padding: 1.5vh 3vw; border-radius: 50px; color: white; font-weight: 800; font-family: 'Press Start 2P';
            font-size: 2.5vh; z-index: 120; text-shadow: 0 2px 4px rgba(0,0,0,0.5); pointer-events: none;
        }
        .notif.anim { animation: popFade 1.2s forwards; }
        @keyframes popFade { 0% { transform: translate(-50%) scale(0); opacity: 0; } 20% { transform: translate(-50%) scale(1.2); opacity: 1; } 100% { transform: translate(-50%) scale(1); opacity: 0; top: 20%; } }

        /* UTILS */
        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-2px, 0, 0); } 20%, 80% { transform: translate3d(4px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-6px, 0, 0); } 40%, 60% { transform: translate3d(6px, 0, 0); } }

        #voiceIndicator {
            position: absolute; bottom: 3vh; right: 3vw; width: 7vh; height: 7vh;
            border-radius: 50%; background: #ff4757; color: white; display: flex;
            align-items: center; justify-content: center; font-size: 3vh; border: 4px solid rgba(255,255,255,0.3);
            z-index: 60; transition: transform 0.1s, background 0.3s;
        }
        #voiceIndicator.active { background: #2ed573; transform: scale(1.2); }
    </style>
</head>
<body>

    <div id="gameContainer" class="theme-default">
        <div class="sun" style="position: absolute; top: 10vh; right: 10vw; font-size: 10vh; filter: drop-shadow(0 0 20px orange);">‚òÄÔ∏è</div>
        <div class="cloud" style="position: absolute; top: 15vh; left: 10vw; font-size: 8vh; opacity: 0.8;">‚òÅÔ∏è</div>

        <div id="hud">
            <div class="panel">
                <span class="panel-label" data-i18n="score">PUNTI</span>
                <span class="panel-value" id="scoreVal">0</span>
            </div>
            <div class="panel" id="livesPanel">
                <span class="heart">‚ù§Ô∏è</span><span class="heart">‚ù§Ô∏è</span><span class="heart">‚ù§Ô∏è</span>
            </div>
        </div>

        <div id="topButtons">
            <div class="icon-btn" id="btnPause">‚è∏Ô∏è</div>
        </div>

        <div id="rooster">üêì</div>
        <div class="grass-container" id="grassRow"></div>
        <div id="ground"></div>

        <div id="voiceIndicator">üé§</div>
        <div id="countdown">3</div>
        <div class="notif" id="notifArea"></div>

        <div id="startScreen" class="screen">
            <h1>ROOSTER<br>RUNNER<br><span style="font-size:0.6em; color:white;">PRO</span></h1>
            <p class="subtitle" data-i18n="subtitle">Il Gallo pi√π Veloce del Web</p>
            <div class="btn-group">
                <button class="main-btn" id="btnStartMic">üé§ <span data-i18n="btn-mic">Gioca con Voce</span></button>
                <button class="main-btn secondary" id="btnStartTap">üëÜ <span data-i18n="btn-touch">Gioca con Tocco</span></button>
                <button class="main-btn settings-trigger" onclick="ui.openSettings()">‚öôÔ∏è <span data-i18n="settings">Impostazioni</span></button>
            </div>
        </div>

        <div id="pauseScreen" class="screen hidden" style="background: rgba(0,0,0,0.6);">
            <h1><span data-i18n="pause">PAUSA</span></h1>
            <div class="btn-group">
                <button class="main-btn" id="btnResume">‚ñ∂Ô∏è <span data-i18n="resume">Riprendi</span></button>
                <button class="main-btn settings-trigger" onclick="ui.openSettings()">‚öôÔ∏è <span data-i18n="settings">Impostazioni</span></button>
                <button class="main-btn secondary" onclick="game.reset()">üè† <span data-i18n="menu">Menu</span></button>
            </div>
        </div>

        <div id="gameOverScreen" class="screen hidden">
            <h1 style="color: #ff4757">GAME OVER</h1>
            <div style="font-size: 3vh; color: white; margin-bottom: 4vh; font-family: 'Press Start 2P'">
                <div data-i18n="score">PUNTEGGIO</div>
                <div id="finalScore" style="color: #FFD700; font-size: 6vh; margin-top: 1vh;">0</div>
            </div>
            <div class="btn-group">
                <button class="main-btn" onclick="game.restart()">üîÑ <span data-i18n="retry">Riprova</span></button>
                <button class="main-btn secondary" onclick="game.reset()">üè† <span data-i18n="menu">Menu</span></button>
            </div>
        </div>

        <div id="settingsOverlay">
            <div class="settings-header">
                <h2 style="color:white; font-family: 'Poppins';"><span data-i18n="settings">Impostazioni</span></h2>
                <div class="close-btn" onclick="ui.closeSettings()">‚úï</div>
            </div>

            <div class="setting-group">
                <div class="setting-title">üåç <span data-i18n="language">Lingua</span></div>
                <div class="grid-options" id="optLang">
                    <div class="opt-btn" onclick="settings.setLang('it')"><span class="emoji">üáÆüáπ</span>ITA</div>
                    <div class="opt-btn" onclick="settings.setLang('en')"><span class="emoji">üá¨üáß</span>ENG</div>
                    <div class="opt-btn" onclick="settings.setLang('es')"><span class="emoji">üá™üá∏</span>ESP</div>
                </div>
            </div>

            <div class="setting-group">
                <div class="setting-title">üé® <span data-i18n="theme">Tema</span></div>
                <div class="grid-options" id="optTheme">
                    <div class="opt-btn" onclick="settings.setTheme('default')"><span class="emoji">üå§Ô∏è</span>Day</div>
                    <div class="opt-btn" onclick="settings.setTheme('sunset')"><span class="emoji">üåÖ</span>Sun</div>
                    <div class="opt-btn" onclick="settings.setTheme('night')"><span class="emoji">üåô</span>Night</div>
                    <div class="opt-btn" onclick="settings.setTheme('desert')"><span class="emoji">üèúÔ∏è</span>Sand</div>
                </div>
            </div>

            <div class="setting-group">
                <div class="setting-title">üêæ <span data-i18n="character">Personaggio</span></div>
                <div class="grid-options" id="optChar">
                    <div class="opt-btn" onclick="settings.setChar('üêì')"><span class="emoji">üêì</span></div>
                    <div class="opt-btn" onclick="settings.setChar('ü¶Ü')"><span class="emoji">ü¶Ü</span></div>
                    <div class="opt-btn" onclick="settings.setChar('üêß')"><span class="emoji">üêß</span></div>
                    <div class="opt-btn" onclick="settings.setChar('ü¶ñ')"><span class="emoji">ü¶ñ</span></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        /**
         * ROOSTER RUNNER PRO - Optimized Logic
         * Features: State Machine, Delta Time Physics, AudioContext API, LocalStorage
         */

        // --- CONFIG & STATE ---
        const CONFIG = {
            gravity: 0.15,
            jumpForce: 2.8,
            speedBase: 0.8,
            speedMax: 2.5,
            obsInterval: 120, // Frames roughly
            micThreshold: 25
        };

        const STATE = {
            screen: 'START', // START, GAME, PAUSE, GAMEOVER
            isPlaying: false,
            isPaused: false,
            score: 0,
            lives: 3,
            speed: 1,
            frame: 0,
            lastTime: 0,
            micActive: false,
            invincible: false
        };

        const TRANSLATIONS = {
            it: { subtitle: "Corri Gallo Corri!", "btn-mic": "VOCE", "btn-touch": "TOCCO", score: "PUNTI", pause: "PAUSA", resume: "RIPRENDI", settings: "IMPOSTAZIONI", menu: "MENU", retry: "RIPROVA", theme: "TEMA", language: "LINGUA", character: "PERSONAGGIO" },
            en: { subtitle: "Run Rooster Run!", "btn-mic": "VOICE", "btn-touch": "TOUCH", score: "SCORE", pause: "PAUSED", resume: "RESUME", settings: "SETTINGS", menu: "MENU", retry: "RETRY", theme: "THEME", language: "LANGUAGE", character: "CHARACTER" },
            es: { subtitle: "¬°Corre Gallo Corre!", "btn-mic": "VOZ", "btn-touch": "TOQUE", score: "PUNTOS", pause: "PAUSA", resume: "CONTINUAR", settings: "AJUSTES", menu: "MENU", retry: "REINTENTAR", theme: "TEMA", language: "IDIOMA", character: "PERSONAJE" }
        };

        // --- ELEMENTS ---
        const $ = (id) => document.getElementById(id);
        const els = {
            container: $('gameContainer'),
            rooster: $('rooster'),
            score: $('scoreVal'),
            finalScore: $('finalScore'),
            lives: $('livesPanel'),
            screens: {
                start: $('startScreen'),
                pause: $('pauseScreen'),
                over: $('gameOverScreen'),
                settings: $('settingsOverlay')
            },
            grass: $('grassRow'),
            voiceInd: $('voiceIndicator'),
            countdown: $('countdown'),
            notif: $('notifArea')
        };

        // --- AUDIO ENGINE (Professional Synth) ---
        const audio = {
            ctx: null,
            init: () => {
                if (!audio.ctx) audio.ctx = new (window.AudioContext || window.webkitAudioContext)();
            },
            play: (type) => {
                if (!audio.ctx) return;
                const osc = audio.ctx.createOscillator();
                const gain = audio.ctx.createGain();
                osc.connect(gain);
                gain.connect(audio.ctx.destination);

                const now = audio.ctx.currentTime;
                
                if (type === 'jump') {
                    osc.frequency.setValueAtTime(300, now);
                    osc.frequency.exponentialRampToValueAtTime(600, now + 0.1);
                    gain.gain.setValueAtTime(0.3, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
                    osc.start(now); osc.stop(now + 0.15);
                } else if (type === 'hit') {
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(150, now);
                    osc.frequency.exponentialRampToValueAtTime(40, now + 0.3);
                    gain.gain.setValueAtTime(0.4, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                    osc.start(now); osc.stop(now + 0.3);
                } else if (type === 'coin') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(1200, now);
                    osc.frequency.setValueAtTime(1800, now + 0.05);
                    gain.gain.setValueAtTime(0.2, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                    osc.start(now); osc.stop(now + 0.1);
                }
            }
        };

        // --- SETTINGS MANAGER ---
        const settings = {
            data: { lang: 'it', theme: 'default', char: 'üêì' },
            load: () => {
                const saved = localStorage.getItem('rr_settings');
                if (saved) settings.data = JSON.parse(saved);
                settings.apply();
            },
            save: () => {
                localStorage.setItem('rr_settings', JSON.stringify(settings.data));
            },
            setLang: (l) => { settings.data.lang = l; settings.apply(); settings.save(); },
            setTheme: (t) => { settings.data.theme = t; settings.apply(); settings.save(); },
            setChar: (c) => { settings.data.char = c; settings.apply(); settings.save(); },
            apply: () => {
                // UI Update
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    if (TRANSLATIONS[settings.data.lang][key]) el.textContent = TRANSLATIONS[settings.data.lang][key];
                });
                els.container.className = `theme-${settings.data.theme}`;
                els.rooster.textContent = settings.data.char;

                // Active states in menu
                document.querySelectorAll('.opt-btn').forEach(b => b.classList.remove('active'));
                // Simple logic to highlight active buttons (could be optimized)
                // Leaving simple for single file readability
            }
        };

        // --- GAME LOOP & PHYSICS ---
        const game = {
            raf: null,
            entities: [],
            roosterY: 0,
            velocity: 0,
            
            start: (micMode) => {
                audio.init();
                STATE.micActive = micMode;
                els.voiceInd.style.display = micMode ? 'flex' : 'none';
                if (micMode) mic.start();
                
                game.resetStats();
                ui.showScreen(null); // Hide all
                ui.countdown(() => {
                    STATE.isPlaying = true;
                    STATE.lastTime = performance.now();
                    game.loop();
                });
            },

            resetStats: () => {
                STATE.score = 0;
                STATE.lives = 3;
                STATE.speed = CONFIG.speedBase;
                STATE.invincible = false;
                game.entities.forEach(e => e.el.remove());
                game.entities = [];
                game.roosterY = 0;
                game.velocity = 0;
                game.updateLives();
            },

            reset: () => {
                cancelAnimationFrame(game.raf);
                STATE.isPlaying = false;
                STATE.isPaused = false;
                ui.showScreen('start');
                game.entities.forEach(e => e.el.remove());
                game.entities = [];
            },

            restart: () => {
                game.start(STATE.micActive);
            },

            pause: () => {
                if (!STATE.isPlaying) return;
                STATE.isPaused = !STATE.isPaused;
                if (STATE.isPaused) {
                    cancelAnimationFrame(game.raf);
                    ui.showScreen('pause');
                } else {
                    ui.showScreen(null);
                    ui.countdown(() => {
                        STATE.lastTime = performance.now();
                        game.loop();
                    });
                }
            },

            jump: () => {
                if (game.roosterY <= 0) { // Only jump if on ground
                    game.velocity = CONFIG.jumpForce;
                    audio.play('jump');
                    els.rooster.classList.remove('running');
                }
            },

            hit: () => {
                if (STATE.invincible) return;
                STATE.lives--;
                STATE.invincible = true;
                audio.play('hit');
                game.updateLives();
                
                // Shake effect
                els.container.classList.add('shake');
                setTimeout(() => els.container.classList.remove('shake'), 500);

                els.rooster.style.opacity = 0.5;
                setTimeout(() => { STATE.invincible = false; els.rooster.style.opacity = 1; }, 1500);

                if (STATE.lives <= 0) game.over();
            },

            over: () => {
                STATE.isPlaying = false;
                cancelAnimationFrame(game.raf);
                els.finalScore.textContent = Math.floor(STATE.score);
                ui.showScreen('over');
            },

            updateLives: () => {
                els.lives.innerHTML = '';
                for(let i=0; i<3; i++) {
                    const h = document.createElement('span');
                    h.className = `heart ${i < STATE.lives ? '' : 'lost'}`;
                    h.textContent = '‚ù§Ô∏è';
                    els.lives.appendChild(h);
                }
            },

            spawn: () => {
                const type = Math.random() > 0.8 ? 'fly' : (Math.random() > 0.9 ? 'coin' : 'obs');
                const el = document.createElement('div');
                let obj = { el, x: 110, type, scored: false };

                if (type === 'obs') {
                    el.className = 'obstacle';
                    el.textContent = ['üåµ','ü™®','ü™µ','üçÑ'][Math.floor(Math.random()*4)];
                    el.style.bottom = '12vh';
                } else if (type === 'fly') {
                    el.className = 'enemy';
                    el.textContent = 'ü¶Ö';
                } else {
                    el.className = 'powerup';
                    el.textContent = 'üåΩ';
                    el.style.bottom = '15vh';
                }
                
                el.style.left = '110vw';
                els.container.appendChild(el);
                game.entities.push(obj);
            },

            loop: (now) => {
                if (!STATE.isPlaying || STATE.isPaused) return;
                
                // Delta Time calculation for smooth movement regardless of framerate
                const dt = (now - STATE.lastTime) / 16.67; 
                STATE.lastTime = now;
                const delta = isNaN(dt) ? 1 : Math.min(dt, 2); // Cap delta to prevent huge jumps

                // Physics
                game.velocity -= CONFIG.gravity * delta;
                game.roosterY += game.velocity * delta;
                
                if (game.roosterY <= 0) {
                    game.roosterY = 0;
                    game.velocity = 0;
                    if(!els.rooster.classList.contains('running')) els.rooster.classList.add('running');
                }
                els.rooster.style.bottom = `calc(12vh + ${game.roosterY}vh)`;
                els.rooster.style.transform = `scaleX(-1) rotate(${game.velocity * -5}deg)`;

                // Spawning
                STATE.frame += delta;
                if (STATE.frame > (CONFIG.obsInterval / STATE.speed)) {
                    game.spawn();
                    STATE.frame = 0;
                }

                // Entities
                const moveSpeed = CONFIG.speedBase * STATE.speed * delta;
                
                for (let i = game.entities.length - 1; i >= 0; i--) {
                    let ent = game.entities[i];
                    ent.x -= moveSpeed;
                    ent.el.style.left = ent.x + 'vw';

                    // Collision Logic
                    if (ent.x < 20 && ent.x > 10) { // Near rooster x range (15vw)
                        // Simple box collision approximation
                        let collision = false;
                        if (ent.type === 'obs' && game.roosterY < 5) collision = true;
                        if (ent.type === 'fly' && game.roosterY > 10) collision = true;
                        
                        if (collision) {
                            game.hit();
                            ent.el.remove();
                            game.entities.splice(i, 1);
                            continue;
                        } else if (ent.type === 'coin') {
                            // Collect coin logic here if needed
                        }
                    }

                    // Score
                    if (!ent.scored && ent.x < 10) {
                        STATE.score += 10;
                        ent.scored = true;
                        els.score.textContent = Math.floor(STATE.score);
                        
                        // Speed up
                        if(STATE.score % 100 === 0) STATE.speed = Math.min(CONFIG.speedMax, STATE.speed + 0.1);
                    }

                    // Cleanup
                    if (ent.x < -10) {
                        ent.el.remove();
                        game.entities.splice(i, 1);
                    }
                }

                game.raf = requestAnimationFrame(game.loop);
            }
        };

        // --- MICROPHONE LOGIC ---
        const mic = {
            stream: null,
            analyser: null,
            data: null,
            start: async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    const audioCtx = audio.ctx;
                    const src = audioCtx.createMediaStreamSource(stream);
                    mic.analyser = audioCtx.createAnalyser();
                    mic.analyser.fftSize = 256;
                    src.connect(mic.analyser);
                    mic.data = new Uint8Array(mic.analyser.frequencyBinCount);
                    mic.listen();
                } catch(e) {
                    console.error("Mic error", e);
                    alert("Microfono non rilevato.");
                }
            },
            listen: () => {
                if (!STATE.isPlaying || STATE.isPaused) {
                    requestAnimationFrame(mic.listen);
                    return;
                }
                mic.analyser.getByteFrequencyData(mic.data);
                let sum = 0;
                for(let i=0; i < mic.data.length; i++) sum += mic.data[i];
                let avg = sum / mic.data.length;
                
                if (avg > CONFIG.micThreshold) {
                    els.voiceInd.classList.add('active');
                    game.jump();
                } else {
                    els.voiceInd.classList.remove('active');
                }
                requestAnimationFrame(mic.listen);
            }
        };

        // --- UI MANAGER ---
        const ui = {
            showScreen: (name) => {
                Object.values(els.screens).forEach(s => s.classList.add('hidden'));
                if (name && els.screens[name]) els.screens[name].classList.remove('hidden');
                
                // Disable pause btn on start/over screens
                $('btnPause').classList.toggle('disabled', name === 'start' || name === 'over');
            },
            
            openSettings: () => {
                // If playing, force pause first
                if (STATE.isPlaying && !STATE.isPaused) {
                    game.pause(); 
                    // Hide pause screen temporarily to show settings cleanly, 
                    // or keep it below. Let's keep it below.
                }
                els.screens.settings.classList.add('active');
            },

            closeSettings: () => {
                els.screens.settings.classList.remove('active');
                // If we were paused, remain paused.
                // If we were at start menu, remain there.
            },

            countdown: (cb) => {
                let count = 3;
                els.countdown.style.display = 'block';
                els.countdown.textContent = count;
                
                let int = setInterval(() => {
                    count--;
                    if(count > 0) {
                        els.countdown.textContent = count;
                    } else {
                        clearInterval(int);
                        els.countdown.textContent = "GO!";
                        setTimeout(() => {
                            els.countdown.style.display = 'none';
                            cb();
                        }, 500);
                    }
                }, 600);
            }
        };

        // --- INITIALIZATION ---
        window.onload = () => {
            settings.load();
            
            // Grass Gen
            for(let i=0; i<15; i++) {
                let g = document.createElement('div');
                g.className = 'grass';
                g.textContent = 'üåø';
                g.style.left = (i*8) + 'vw';
                g.style.animationDelay = (i*0.1)+'s';
                els.grass.appendChild(g);
            }

            // Event Listeners
            $('btnStartMic').onclick = () => game.start(true);
            $('btnStartTap').onclick = () => game.start(false);
            $('btnPause').onclick = () => game.pause();
            $('btnResume').onclick = () => game.pause();
            
            // Global Input
            document.addEventListener('keydown', (e) => {
                if (e.code === 'Space' || e.code === 'ArrowUp') {
                    if(!STATE.isPlaying && !els.screens.start.classList.contains('hidden')) game.start(false);
                    else game.jump();
                }
                if (e.code === 'Escape' || e.code === 'KeyP') game.pause();
            });

            els.container.addEventListener('touchstart', (e) => {
                if(e.target.tagName !== 'BUTTON') game.jump();
            }, {passive: false});
            els.container.addEventListener('mousedown', (e) => {
                if(e.target.tagName !== 'BUTTON') game.jump();
            });
        };

    </script>
</body>
</html>
